<!doctype html>
<html>
  <head>
    <title>Spotify Playlist Audio Features</title>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/vega@6.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@6.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
    <style media="screen">
      /* Add space between Vega-Embed links  */
      .vega-actions a {
        margin-right: 5px;
      }
      body {
        font-family: sans-serif;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Spotify Playlist Audio Features Analysis</h1>
    
    <!-- Container for the visualization -->
    <div id="vis"></div>
    
    <script>
      // Load the external JSON data and create visualization
      fetch('query-results.json')
        .then(response => response.json())
        .then(data => {
          
          // Transform the data to flatten the audio features
          const transformedData = data.map(song => {
            const features = song.reccobeats && song.reccobeats[0] ? song.reccobeats[0] : {};
            return {
              name: song.name,
              addedBy: song.addedBy ? song.addedBy.id : 'unknown',
              duration_minutes: song.duration / 60000, // Convert to minutes
              acousticness: features.acousticness || 0,
              danceability: features.danceability || 0,
              energy: features.energy || 0,
              instrumentalness: features.instrumentalness || 0,
              speechiness: features.speechiness || 0,
              tempo: features.tempo || 0,
              valence: features.valence || 0,
              loudness: features.loudness || 0
            };
          }).filter(song => song.danceability > 0); // Filter out songs without audio features
          
          // Create an interactive scatter plot
          var vlSpec = {
            $schema: 'https://vega.github.io/schema/vega-lite/v6.json',
            title: 'Song Energy vs Valence (Mood)',
            width: 800,
            height: 500,
            data: {
              values: transformedData
            },
            mark: {
              type: 'point',
              filled: true,
              size: 100,
              opacity: 0.7,
              tooltip: true
            },
            encoding: {
              x: {
                field: 'energy',
                type: 'quantitative',
                scale: {domain: [0, 1]},
                title: 'Energy (0 = Low, 1 = High)'
              },
              y: {
                field: 'valence',
                type: 'quantitative',
                scale: {domain: [0, 1]},
                title: 'Valence/Mood (0 = Sad, 1 = Happy)'
              },
              color: {
                field: 'addedBy',
                type: 'nominal',
                title: 'Added By',
                scale: {
                  scheme: 'category10'
                }
              },
              size: {
                field: 'danceability',
                type: 'quantitative',
                scale: {range: [50, 400]},
                title: 'Danceability',
                legend: {
                  title: 'Danceability'
                }
              },
              tooltip: [
                {field: 'name', type: 'nominal', title: 'Song'},
                {field: 'addedBy', type: 'nominal', title: 'Added By'},
                {field: 'energy', type: 'quantitative', format: '.2f'},
                {field: 'valence', type: 'quantitative', format: '.2f', title: 'Mood'},
                {field: 'danceability', type: 'quantitative', format: '.2f'},
                {field: 'acousticness', type: 'quantitative', format: '.2f'},
                {field: 'tempo', type: 'quantitative', format: '.1f', title: 'BPM'},
                {field: 'duration_minutes', type: 'quantitative', format: '.1f', title: 'Duration (min)'}
              ]
            },
            config: {
              axis: {
                grid: true,
                gridOpacity: 0.3
              }
            }
          };
          
          // Embed the visualization
          vegaEmbed('#vis', vlSpec);
        })
        .catch(error => {
          console.error('Error loading data:', error);
          document.getElementById('vis').innerHTML = '<p>Error loading data. Make sure query-results.json is in the same directory.</p>';
        });
    </script>
    
    <h2>About this Visualization</h2>
    <p>This chart shows the relationship between song energy and mood (valence) in your playlist:</p>
    <ul>
      <li><b>X-axis (Energy):</b> How intense and active the song feels</li>
      <li><b>Y-axis (Valence/Mood):</b> Musical positivity - happy/cheerful vs sad/angry</li>
      <li><b>Size:</b> How danceable the track is</li>
      <li><b>Color:</b> Who added the song to the playlist</li>
    </ul>
    <p>Hover over points to see detailed information about each song.</p>
  </body>
</html>
