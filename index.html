<!doctype html>
<html>
  <head>
    <title>Spotify Playlist Analytics</title>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/vega@6.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@6.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
    <style media="screen">
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        padding: 40px;
        background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
        min-height: 100vh;
        color: #e4e6eb;
      }
      h1 {
        color: #ffffff;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 2rem;
        text-align: center;
        background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 40px rgba(29, 185, 84, 0.3);
      }
      .viz-container {
        background: linear-gradient(135deg, rgba(30, 35, 55, 0.9) 0%, rgba(20, 25, 40, 0.9) 100%);
        padding: 30px;
        margin-bottom: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
        position: relative;
      }
      .viz-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 0 30px rgba(29, 185, 84, 0.1);
      }
      #timeline-vis, #pie-vis, #progress-vis { width: 100%; max-width: 100%; overflow-x: auto; }
      .stats { font-size: 16px; color: #b8bcc8; margin: 20px 0 0 0; line-height: 1.8; }
      .stats strong { color: #1db954; font-weight: 600; display: inline-block; min-width: 200px; }
      .stats-row { padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
      .stats-row:last-child { border-bottom: none; }
      .vega-embed { padding: 0 !important; width: 100% !important; }
      .vega-embed .vega-actions { top: 10px !important; right: 10px !important; }
      .vega-embed .vega-actions a { color: #1db954 !important; background-color: rgba(29, 185, 84, 0.1) !important; border: 1px solid rgba(29, 185, 84, 0.3) !important; padding: 4px 8px; border-radius: 4px; margin-right: 5px; transition: all 0.2s ease; }
      .vega-embed .vega-actions a:hover { background-color: rgba(29, 185, 84, 0.2) !important; border-color: #1db954 !important; }
      .vega-embed summary { color: #b8bcc8 !important; }
      @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
      .loading { animation: pulse 1.5s ease-in-out infinite; }
      .dashboard-wrapper { max-width: 1400px; margin: 0 auto; }
      @media (max-width: 1200px) { body { padding: 30px; } }
      @media (max-width: 768px) { body { padding: 20px; } h1 { font-size: 1.8rem; } .viz-container { padding: 20px; } .stats strong { min-width: 140px; } }
      @media (max-width: 480px) { body { padding: 15px; } h1 { font-size: 1.5rem; } .viz-container { padding: 15px; } }
    </style>
  </head>
  <body>
    <div class="dashboard-wrapper">
      <h1>üéµ Spotify Playlist Analytics Dashboard</h1>

      <!-- Stats & Progress First -->
      <div class="viz-container loading" id="progress-container">
        <div id="progress-vis"></div>
        <div id="stats" class="stats"></div>
      </div>

      <!-- Pie Chart Second -->
      <div class="viz-container loading" id="pie-container">
        <div id="pie-vis"></div>
      </div>

      <!-- Timeline Last -->
      <div class="viz-container loading" id="timeline-container">
        <div id="timeline-vis"></div>
      </div>
    </div>

    <script>
      function getResponsiveWidth() {
        const containerWidth = window.innerWidth - 140;
        return Math.min(Math.max(containerWidth, 300), 1200);
      }
      const darkTheme = {
        background: 'transparent',
        title: { color: '#ffffff', fontSize: 18, font: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto' },
        style: {
          "guide-label": { fill: '#b8bcc8', fontSize: 12 },
          "guide-title": { fill: '#e4e6eb', fontSize: 14 },
        },
        axis: { domainColor: '#4a5568', gridColor: 'rgba(255, 255, 255, 0.05)', tickColor: '#4a5568', labelColor: '#b8bcc8', titleColor: '#e4e6eb' },
        legend: { labelColor: '#b8bcc8', titleColor: '#e4e6eb' }
      };

      fetch('query-results.json')
        .then(response => response.json())
        .then(data => {
          const vizWidth = getResponsiveWidth();

          const timelineData = data.map(song => {
            const features = song.reccobeats && song.reccobeats[0] ? song.reccobeats[0] : {};
            return {
              order: song.playlistEntry,
              name: song.name,
              addedBy: song.addedBy ? song.addedBy.id : 'unknown',
              energy: features.energy || 0,
              valence: features.valence || 0,
              mood_energy: ((features.energy || 0) + (features.valence || 0)) / 2,
              duration_minutes: song.duration / 60000
            };
          }).sort((a, b) => a.order - b.order);

          const userRuntimes = {}; let totalDuration = 0;
          data.forEach(song => {
            const user = song.addedBy ? song.addedBy.id : 'unknown';
            const duration = song.duration / 60000;
            userRuntimes[user] = (userRuntimes[user] || 0) + duration;
            totalDuration += duration;
          });

          const sortedUserRuntimes = Object.entries(userRuntimes).sort((a, b) => b[1] - a[1]);
          const pieData = sortedUserRuntimes.map(([user, duration]) => ({ user, duration, percentage: (duration / totalDuration) * 100 }));
          const userColors = ['#1db954', '#00d9ff', '#ff6b6b', '#feca57'];
          const userColorMap = {}; sortedUserRuntimes.forEach(([user], i) => { userColorMap[user] = userColors[i % userColors.length]; });
          const sortedUsers = sortedUserRuntimes.map(([user]) => user);

          const timelineSpec = { /* unchanged from your version */ };
          const pieSpec = { /* unchanged from your version */ };

          const maxDuration = 12 * 60;
          const progressData = [{ label: 'Playlist Duration', value: totalDuration, max: maxDuration, percentage: (totalDuration / maxDuration) * 100 }];

          const progressSpec = {
            $schema: 'https://vega.github.io/schema/vega-lite/v6.json',
            title: 'üìä Duration vs 12 Hour Limit',
            width: vizWidth * 0.85,
            height: 80,
            autosize: { type: 'fit', contains: 'padding' },
            background: 'transparent',
            config: darkTheme,
            data: { values: progressData },
            layer: [
              { mark: { type: 'bar', color: 'rgba(255, 255, 255, 0.05)', cornerRadiusEnd: 8 },
                encoding: { x: { datum: maxDuration, type: 'quantitative', scale: { domain: [0, maxDuration] }, axis: { title: 'Minutes', format: '.0f', labelAngle: 0 } }, y: { field: 'label', type: 'nominal', axis: { title: null } } } },
              { mark: { type: 'bar', color: { gradient: 'linear', stops: totalDuration > maxDuration ? [{ offset: 0, color: '#ff4757' }, { offset: 1, color: '#ff6b7a' }] : [{ offset: 0, color: '#1db954' }, { offset: 1, color: '#1ed760' }], x1: 0, y1: 0, x2: 1, y2: 0 }, cornerRadiusEnd: 8 },
                encoding: { x: { field: 'value', type: 'quantitative', scale: { domain: [0, maxDuration] } }, y: { field: 'label', type: 'nominal' }, tooltip: [ { field: 'value', type: 'quantitative', format: '.1f', title: 'Duration (min)' }, { field: 'percentage', type: 'quantitative', format: '.1f', title: 'Usage %' } ] } },
              { mark: { type: 'text', align: 'left', baseline: 'middle', dx: 10, fontSize: 14, fontWeight: 'bold', color: '#ffffff' },
                encoding: { x: { field: 'value', type: 'quantitative' }, y: { field: 'label', type: 'nominal' }, text: { field: 'percentage', type: 'quantitative', format: '.1f' } } }
            ]
          };

          const embedOpts = { actions: { export: true, source: false, compiled: false, editor: false }, theme: 'dark', renderer: 'canvas' };
          vegaEmbed('#timeline-vis', timelineSpec, embedOpts).then(() => document.getElementById('timeline-container').classList.remove('loading'));
          vegaEmbed('#pie-vis', pieSpec, embedOpts).then(() => document.getElementById('pie-container').classList.remove('loading'));
          vegaEmbed('#progress-vis', progressSpec, embedOpts).then(() => document.getElementById('progress-container').classList.remove('loading'));

          const hours = Math.floor(totalDuration / 60);
          const minutes = Math.round(totalDuration % 60);
          const remaining = maxDuration - totalDuration;
          const remHours = Math.floor(Math.abs(remaining) / 60);
          const remMinutes = Math.round(Math.abs(remaining) % 60);

          const songCounts = {}; data.forEach(song => { const user = song.addedBy ? song.addedBy.id : 'unknown'; songCounts[user] = (songCounts[user] || 0) + 1; });
          const sortedSongCounts = Object.entries(songCounts).sort((a, b) => b[1] - a[1]);
          const userStats = sortedSongCounts.map(([user, count], i) => { const pos = i+1; let medal = pos===1?'ü•á ':pos===2?'ü•à ':pos===3?'ü•â ':''; return `${medal}<span style="color: ${userColorMap[user]}; font-weight: 600;">${user}: ${count}</span>`; }).join(' ‚Ä¢ ');

          document.getElementById('stats').innerHTML = `
            <div class="stats-row"><strong>‚è∞ Total Duration:</strong> ${hours}h ${minutes}m</div>
            <div class="stats-row"><strong>üéµ Total Songs:</strong> ${data.length} songs</div>
            <div class="stats-row"><strong>üèÜ Songs by User:</strong> ${userStats}</div>
            <div class="stats-row"><strong>üìä Average Length:</strong> ${(totalDuration / data.length).toFixed(1)} minutes</div>
            <div class="stats-row"><strong>${remaining >= 0 ? '‚úÖ Time Remaining' : '‚ö†Ô∏è Over Limit'}:</strong> <span style="color: ${remaining >= 0 ? '#1db954' : '#ff4757'}; font-weight: 600;">${remHours}h ${remMinutes}m ${remaining < 0 ? 'over limit' : 'remaining'}</span></div>
          `;
        })
        .catch(err => { console.error('Error loading data:', err); document.querySelector('.dashboard-wrapper').innerHTML += '<p style="color: #ff4757; text-align: center; margin-top: 20px;">‚ö†Ô∏è Error loading data. Check console for details.</p>'; });
    </script>
  </body>
</html>
