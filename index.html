<!doctype html>
<html>
  <head>
    <title>Spotify Playlist Analytics</title>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/vega@6.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@6.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
    <style media="screen">
      .vega-actions a {
        margin-right: 5px;
      }
      body {
        font-family: sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .viz-container {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      h1 {
        color: #333;
      }
      .stats {
        font-size: 18px;
        color: #666;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>Spotify Playlist Analytics Dashboard</h1>
    
    <div class="viz-container">
      <div id="timeline-vis"></div>
    </div>
    
    <div class="viz-container">
      <div id="pie-vis"></div>
    </div>
    
    <div class="viz-container">
      <div id="progress-vis"></div>
      <div id="stats" class="stats"></div>
    </div>
    
    <script>
      fetch('query-results.json')
        .then(response => response.json())
        .then(data => {
          
          // Process data for timeline
          const timelineData = data.map(song => {
            const features = song.reccobeats && song.reccobeats[0] ? song.reccobeats[0] : {};
            return {
              order: song.playlistEntry,
              name: song.name,
              addedBy: song.addedBy ? song.addedBy.id : 'unknown',
              energy: features.energy || 0,
              valence: features.valence || 0,
              mood_energy: ((features.energy || 0) + (features.valence || 0)) / 2,
              duration_minutes: song.duration / 60000
            };
          }).sort((a, b) => a.order - b.order);
          
          // Calculate runtime by user
          const userRuntimes = {};
          let totalDuration = 0;
          
          data.forEach(song => {
            const user = song.addedBy ? song.addedBy.id : 'unknown';
            const duration = song.duration / 60000;
            userRuntimes[user] = (userRuntimes[user] || 0) + duration;
            totalDuration += duration;
          });
          
          const pieData = Object.entries(userRuntimes).map(([user, duration]) => ({
            user: user,
            duration: duration,
            percentage: (duration / totalDuration) * 100
          }));
          
          // Timeline Visualization
          const timelineSpec = {
            $schema: 'https://vega.github.io/schema/vega-lite/v6.json',
            title: 'Playlist Order: Energy + Mood Timeline',
            width: 900,
            height: 400,
            data: { values: timelineData },
            layer: [
              {
                mark: {
                  type: 'area',
                  line: true,
                  color: '#1db954',
                  opacity: 0.3
                },
                encoding: {
                  x: {
                    field: 'order',
                    type: 'quantitative',
                    title: 'Song Order in Playlist',
                    axis: { tickMinStep: 1 }
                  },
                  y: {
                    field: 'mood_energy',
                    type: 'quantitative',
                    scale: { domain: [0, 1] },
                    title: 'Mood + Energy Score (Average)'
                  }
                }
              },
              {
                mark: {
                  type: 'point',
                  filled: true,
                  size: 80,
                  tooltip: true
                },
                encoding: {
                  x: {
                    field: 'order',
                    type: 'quantitative'
                  },
                  y: {
                    field: 'mood_energy',
                    type: 'quantitative'
                  },
                  color: {
                    field: 'addedBy',
                    type: 'nominal',
                    title: 'Added By',
                    scale: {
                      domain: ['m책nen', 'neo', 'r책nse', 'kratos'],
                      range: ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3']
                    }
                  },
                  tooltip: [
                    { field: 'name', type: 'nominal', title: 'Song' },
                    { field: 'addedBy', type: 'nominal', title: 'Added By' },
                    { field: 'order', type: 'quantitative', title: 'Position' },
                    { field: 'energy', type: 'quantitative', format: '.2f' },
                    { field: 'valence', type: 'quantitative', format: '.2f', title: 'Mood' },
                    { field: 'mood_energy', type: 'quantitative', format: '.2f', title: 'Combined Score' }
                  ]
                }
              }
            ]
          };
          
          // Pie Chart Visualization
          const pieSpec = {
            $schema: 'https://vega.github.io/schema/vega-lite/v6.json',
            title: 'Runtime Contribution by User',
            width: 400,
            height: 400,
            data: { values: pieData },
            mark: {
              type: 'arc',
              innerRadius: 50,
              tooltip: true
            },
            encoding: {
              theta: {
                field: 'duration',
                type: 'quantitative',
                stack: true
              },
              color: {
                field: 'user',
                type: 'nominal',
                title: 'User',
                scale: {
                  domain: ['m책nen', 'neo', 'r책nse', 'kratos'],
                  range: ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3']
                }
              },
              tooltip: [
                { field: 'user', type: 'nominal', title: 'User' },
                { field: 'duration', type: 'quantitative', format: '.1f', title: 'Minutes' },
                { field: 'percentage', type: 'quantitative', format: '.1f', title: 'Percentage %' }
              ]
            }
          };
          
          // Progress Bar Visualization
          const maxDuration = 12 * 60; // 12 hours in minutes
          const progressData = [
            {
              label: 'Playlist Duration',
              value: totalDuration,
              max: maxDuration,
              percentage: (totalDuration / maxDuration) * 100
            }
          ];
          
          const progressSpec = {
            $schema: 'https://vega.github.io/schema/vega-lite/v6.json',
            title: 'Playlist Duration vs 12 Hour Limit',
            width: 900,
            height: 100,
            data: { values: progressData },
            layer: [
              {
                mark: {
                  type: 'bar',
                  color: '#e0e0e0'
                },
                encoding: {
                  x: {
                    datum: maxDuration,
                    type: 'quantitative',
                    scale: { domain: [0, maxDuration] },
                    axis: {
                      title: 'Minutes',
                      format: '.0f'
                    }
                  },
                  y: {
                    field: 'label',
                    type: 'nominal',
                    axis: { title: null }
                  }
                }
              },
              {
                mark: {
                  type: 'bar',
                  color: totalDuration > maxDuration ? '#ff4444' : '#1db954'
                },
                encoding: {
                  x: {
                    field: 'value',
                    type: 'quantitative',
                    scale: { domain: [0, maxDuration] }
                  },
                  y: {
                    field: 'label',
                    type: 'nominal'
                  },
                  tooltip: [
                    { field: 'value', type: 'quantitative', format: '.1f', title: 'Current Duration (min)' },
                    { field: 'percentage', type: 'quantitative', format: '.1f', title: 'Usage %' }
                  ]
                }
              },
              {
                mark: {
                  type: 'text',
                  align: 'left',
                  baseline: 'middle',
                  dx: 5,
                  fontSize: 14,
                  fontWeight: 'bold'
                },
                encoding: {
                  x: {
                    field: 'value',
                    type: 'quantitative'
                  },
                  y: {
                    field: 'label',
                    type: 'nominal'
                  },
                  text: {
                    field: 'percentage',
                    type: 'quantitative',
                    format: '.1f'
                  },
                  color: {
                    value: totalDuration > maxDuration ? '#ff4444' : '#1db954'
                  }
                }
              }
            ]
          };
          
          // Embed visualizations
          vegaEmbed('#timeline-vis', timelineSpec);
          vegaEmbed('#pie-vis', pieSpec);
          vegaEmbed('#progress-vis', progressSpec);
          
          // Display stats with user counts
          const hours = Math.floor(totalDuration / 60);
          const minutes = Math.round(totalDuration % 60);
          const remaining = maxDuration - totalDuration;
          const remHours = Math.floor(Math.abs(remaining) / 60);
          const remMinutes = Math.round(Math.abs(remaining) % 60);
          
          // Count songs per user
          const songCounts = {};
          data.forEach(song => {
            const user = song.addedBy ? song.addedBy.id : 'unknown';
            songCounts[user] = (songCounts[user] || 0) + 1;
          });
          
          const userStats = Object.entries(songCounts)
            .map(([user, count]) => `${user}: ${count} songs`)
            .join(', ');
          
          document.getElementById('stats').innerHTML = `
            <strong>Total Playlist Duration:</strong> ${hours} hours ${minutes} minutes<br>
            <strong>Number of Songs:</strong> ${data.length} (${userStats})<br>
            <strong>Average Song Length:</strong> ${(totalDuration / data.length).toFixed(1)} minutes<br>
            <strong>${remaining >= 0 ? 'Time Remaining' : 'Over Limit'}:</strong> 
            <span style="color: ${remaining >= 0 ? 'green' : 'red'}">
              ${remHours} hours ${remMinutes} minutes ${remaining < 0 ? 'over' : 'remaining'}
            </span>
          `;
        })
        .catch(error => {
          console.error('Error loading data:', error);
          document.querySelector('body').innerHTML += '<p style="color: red;">Error loading data. Check console for details.</p>';
        });
    </script>
  </body>
</html>
